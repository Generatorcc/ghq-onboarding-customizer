<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GHQ Setup Options</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 30px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .section {
      margin-top: 30px;
    }
    .card {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    .card label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    button {
      margin-top: 30px;
      padding: 12px 24px;
      font-size: 16px;
      background: #4CBB17;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h1>Choose Your Setup</h1>
<p>Select the templates and automations you want included.</p>

<div id="content"></div>

<button id="continueBtn">Continue to Customizer</button>

<script>
  const params = new URLSearchParams(window.location.search);
  const ghqUserId = params.get("ghq_user_id");

  if (!ghqUserId) {
    alert("Missing ghq_user_id");
  }

  async function loadCatalog() {
    const res = await fetch("/catalog.json");
    return res.json();
  }

  function renderSection(title, items, type) {
    const section = document.createElement("div");
    section.className = "section";
    section.innerHTML = `<h2>${title}</h2>`;

    items.filter(i => i.enabled).forEach(item => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <label>
          <input type="checkbox" data-type="${type}" value="${item.id}">
          ${item.name}
        </label>
      `;
      section.appendChild(card);
    });

    return section;
  }

  loadCatalog().then(catalog => {
    const content = document.getElementById("content");

    content.appendChild(renderSection("Templates", catalog.templates, "templates"));
    content.appendChild(renderSection("Workflows", catalog.workflows, "workflows"));
    content.appendChild(renderSection("Calendars", catalog.calendars, "calendars"));
  });

  document.getElementById("continueBtn").addEventListener("click", async () => {
    const selections = { templates: [], workflows: [], calendars: [] };

    document.querySelectorAll("input[type=checkbox]:checked").forEach(cb => {
      selections[cb.dataset.type].push(cb.value);
    });

    await fetch("/save-selection", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ghq_user_id: ghqUserId,
        selections
      })
    });

    window.location.href = `/index.html?ghq_user_id=${ghqUserId}`;
  });
</script>

</body>
</html>
